{% extends "cciw/standard.html" %}
{% block content %}

<script type="text/javascript" src="{{ pagevars.media_root_url }}/javascript/MochiKit/MochiKit.js"></script>
<script type="text/javascript" src="{{ pagevars.media_root_url }}/javascript/cciwutils.js"></script>
<script type="text/javascript">
<!--

// DEBUG:
//createLoggingPane();

function get_form_row(control_id) {
	var rowId = 'div_' + control_id;
	var row = $(rowId);
	if (row == null) { 
		log("Control " + rowId + " not found.");
	}
	return row;
}

function display_error(control_id, errors) {
	var row = get_form_row(control_id);
	if (row == null) {
		return;
	}
	if (!hasElementClass(row, "validationErrorBottom")) {
		log("Adding nodes to " + row.id);
		// insert <ul> before it
		var newnodes = DIV({'class':'validationErrorTop'}, 
				UL({'class':'errorlist'}, 
				    map(partial(LI, null), errors)));
		row.parentNode.insertBefore(newnodes, row)
		addElementClass(row, "validationErrorBottom");
	}
}

function clear_error(control_id) {
	var row = get_form_row(control_id);
	if (row == null) {
		return;
	}
	if (hasElementClass(row, "validationErrorBottom")) {
		removeElementClass(row, "validationErrorBottom");
		// there will be a previous sibling
		// which holds the error message
		row.parentNode.removeChild(row.previousSibling);
	}
}

function get_validator_callback(control_name, control_id) {
	function handler(req) {
		var json = evalJSONRequest(req);
		log("JSON: " + req.responseText);
		var errors = json[control_name];
		if (errors != null && errors != undefined) {
			log(control_name + " has error: " + errors);
			display_error(control_id, errors);
		} else {
			clear_error(control_id);
		}
	};
	return handler;
}

function ajax_error_handler(err) { 
	log("Err " + repr(err));
}

var formname = 'editpollform';

function do_validate_form(theform) {
	var data = encodeForm($(theform));
	var d = doXHR("?format=json", 
			{
				method:'POST', 
				sendContent: data,
				headers: {
				  "Content-Type": "application/x-www-form-urlencoded"
				} 
			}
	);
	return d;
}

function get_input_change_handler(control_name, control_id) {
	function on_input_change(ev) {
		d = do_validate_form(formname);
		d.addCallbacks(get_validator_callback(control_name, control_id) , ajax_error_handler);
	};
	return on_input_change;
} 

connect(window, 'onload',
	function(ev) {
		// Add event handlers to everything that can be validated.
		var inputs = $(formname).elements;
		for (var i = 0; i < inputs.length; i++) {
			if (defaultFormFilter(inputs[i])) {
				log("Adding onchange handler for control name " + inputs[i].name + ", control id " + inputs[i].id);
				// TODO: need to handle widgets that have more than 
				// one control
				connect(inputs[i], 'onchange', get_input_change_handler(inputs[i].name, inputs[i].id));
			}
		}
	}
);


//-->
</script>

{% if existing_poll %}
<p>Edit the poll details below.  Please note, you can either:</p>
<ul>
  <li>Change the text on existing options (votes for that option will
  be preserved)</li>
  <li>Remove one or more option</li>
  <li>Add one or more option</li>
</ul>
<p>But do not do more than one of the above at once!</p>
{% else %}
<p>Enter the poll details below.  A new topic will be
created for this poll.</p>
{% endif %}

{% if form.errors %}
	<div class="userError">
	Please check your input:
	</div>
{% endif %}

<form action="" method="post" id="editpollform">

<div class="form">
{{ form.as_p }}
</div>

<div><input type="submit" name="submit" id="submit" value="Submit" /></div>
</form>

{% endblock %}

{% extends "cciw/officers/base.html" %}

{% block content %}

  {% partialdef main-content inline %}
    <div id="id_main_content"
         hx-trigger="refreshBookingQueueForCamp-{{ camp.id }}"
         hx-swap="outerHTML"
         hx-post="."
         hx-vals='{"use_partial": "main-content"}'
    >
      <table>
        <thead>
          <tr>
            <th></th>
            <th>Maximum places -
              <a href="{% url 'admin:cciwmain_camp_change' camp.id %}" target="_blank">Edit</a>
            </th>
            <th>Places booked</th>
            <th>Places left</th>
            <th>Ready to allocate</th>
          </tr>
        </thead>
        <tr>
          <th scope="row">Total</th>
          <td>{{ camp.max_places.total }}</td>
          <td>{{ places_booked.total }}</td>
          <td>{{ places_left.total }}</td>
          <td>{{ ready_to_allocate.total }}</td>
        </tr>
        <tr>
          <th scope="row">Male</th>
          <td>{{ camp.max_places.male }}</td>
          <td>{{ places_booked.male }}</td>
          <td>{{ places_left.male }}</td>
          <td>{{ ready_to_allocate.male }}</td>
        </tr>
        <tr>
          <th scope="row">Female</th>
          <td>{{ camp.max_places.female }}</td>
          <td>{{ places_booked.female }}</td>
          <td>{{ places_left.female }}</td>
          <td>{{ ready_to_allocate.female }}</td>
        </tr>
      </table>
      <br>

      <h2>Usage</h2>
      <p>
        This page shows places in the "queue" that are ready to be allocated. Some manual inputs are required, and
        you must then use the buttons at the end to confirm the places.
      </p>

      <h2>Rules</h2>
      <ul>
        <li>“Officer child” - <b>leaders</b> use this to mark campers who are the children of
          officers serving on the same camp.</li>
        <li>“Chosen first timer” - for campers coming for the first time, and are associated with serving officers,
          this option can used by <b>leaders</b> to increase priority for the selected campers.

          It can applied a limited number of times - up to {{ FIRST_TIMER_PERCENTAGE }}%
          of the total places for a camp.</li>
      </ul>
      <h2>Sorting</h2>
      <p>The places are sorted according to our priority rules. After the names,
        the information used for determining priority is shown, starting from
        the highest priority criterion. Hover the headers for more information.
      </p>

      {% if ranked_queue_bookings %}
        <table class="stickyheaders" id="id_queue_table">
          <thead>
            <tr>
              <th>
                <span title="A: will be allocated, T: below the total cutoff, M/F: below the male/female cutoffs">Allocate?</span>
              </th>
              <th>First name</th>
              <th>Last name</th>
              <th>
                <span
                  title="This should be checked if the booking is for a child of someone who is an officer on the same camp."
                >Officer child</span>
              </th>
              <th>
                <span
                  title="Place has been chosen for 'first timer' allocation. Available for up to 10% of places, for leaders to allocate to campers associated with a serving officer."
                >
                  Chosen first timer
                </span>
              </th>
              <th>
                <span title="If a camper has another place booked on another camp, they will be de-prioritised">
                  Other place
                </span>
              </th>
              <th>
                <span
                  title="The position in the queue, this is always '1' for those who book within the initial period. Lower is better."
                >Queue position</span>
              </th>
              <th>
                <span
                  title="The number of times they have previously been on camp. A higher number is better."
                >
                  Previous attendance
                </span>
              </th>
              <th>
                <span
                  title="Was the camper in the waiting list last year, but not offered a place?"
                >
                  Waiting list {{ last_year }}
                </span>
              </th>
              <th>
                <span
                  title="Number of siblings who are likely to be on camp. Higher is better."
                >
                  Sibling bonus
                </span>
              </th>
              <th>
                <span
                  title="This is a random number assigned to each booking as our 'lottery' system. Lower is better."
                >Tiebreaker
                </span>
              </th>
              <th>
                Action
              </th>
            </tr>
          </thead>
          <tbody>
            {% for booking in ranked_queue_bookings %}
              {% include "cciw/officers/booking_queue_row_inc.html" with booking=booking %}
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>No bookings in the queue.</p>
      {% endif %}

      <br>

      {% if problems.has_items %}
        <h2>Problems</h2>
        <ul>
          {% for message in problems.general_messages %}
            <li>{{ message }}</li>
          {% endfor %}
          {% if problems.rejected_officer_children %}
            <li>Some of the places marked as "officer children" have nonetheless fallen below
              the cut-offs and won't have a place allocated:
              <ul>
                {% for booking in problems.rejected_officer_children %}
                  <li>{{ booking.name }}</li>
                {% endfor %}
              </ul>
            </li>
          {% endif %}
          {% if problems.rejected_first_timers %}
            <li>Some of the places marked as "chosen first timers" have nonetheless fallen below
              the cut-offs and won't have a place allocated:
              <ul>
                {% for booking in problems.rejected_first_timers %}
                  <li>{{ booking.name }}</li>
                {% endfor %}
              </ul>
            </li>
          {% endif %}
        </ul>
      {% endif %}

      {% if ranked_queue_bookings and can_allocate_places %}
        <h2>Allocate places</h2>
        {% if ready_to_allocate.total %}
          <p>You may go ahead and allocate the {{ ready_to_allocate.total }} places above that are marked "A". This will:</p>
          <ul>
            <li>Change the status of the place to "booked"</li>
            <li>Notify the booking account that the place is allocated</li>
            <li>Notify others on the list that they haven't been allocated a place (if they haven't been notified of this already)</li>
          </ul>
          <form method="POST" action="">
            {% csrf_token %}
            <button name="allocate">
              Allocate places
            </button>
          </form>
        {% else %}
          <p>No places can be allocated, due to the maximum places set for the camp.</p>
        {% endif %}
      {% elif ranked_queue_bookings %}
        {% if not booking_open_data.is_closed_for_initial_period %}
          <p>The initial booking period is still open, so places can't be allocated yet.
          </p>
        {% else %}
          <p>You don't have the necessary permissions to allocate these places</p>
        {% endif %}
      {% endif %}

    </div>

  {% endpartialdef %}

  <style>
    table#id_queue_table {
      span[title] {
        text-decoration: underline dotted;
        cursor: help;
      }
      input[type=submit] {
        padding: 3px 6px;
        margin: 0;
      }
      td.to-accept {
        background-color: #00ff00;
      }

      th:nth-child(3),
      td:nth-child(3) {
        border-right: 1px solid var(--hairline-color)
      }
    }

  </style>
{% endblock %}

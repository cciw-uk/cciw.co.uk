{% extends "cciw/officers/base.html" %}
{% load adminmedia %}
{% block title %}Officer list :: CCIW{% endblock %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% admin_media_prefix %}css/forms.css" />
<script type="text/javascript" src="{% admin_media_prefix %}js/jquery.min.js"></script>

{% endblock %}
{% block bodyclass%}change-form{% endblock %}

{% block content %}<div id="content-main">
<h1>Officer list - {{ camp }}</h1>

<p>This page can be used for viewing and managing the officers on your list,
 and for viewing those who have not yet filled in an application form.</p>

<div style="float: left; width: 44em;">
<h2>Current list</h2>

{% include "cciw/officers/officer_list_table_editable.html" %}

</div>
<div style="margin-left: 45em;">
<h2 style="margin-top: 2em;">Add to list</h2>

<div class="selector-filter">
<img style="vertical-align: middle" src="/admin_media/img/admin/selector-search.gif">
 <input type="text" id="id_available_officers_filter">
</div>
<div>
<select multiple="multiple" id="id_available_officers" style="min-width:30em;height: 30em;" name="officers">
{% include "cciw/officers/officer_list_available.html" %}
</select>
</div>

<h3>Help</h3>
<ul>
<li>Add an officer from those registered on the system by double clicking
 on the entry above (or use arrow keys and 'Enter').  </li>
<li>Type in the search box to quickly find an officer.</li>
<li>Officers from last year are at the start of the list and starred (if the information is available)</li>
</ul>

<h2>New officer</h2>

<ul>
<li>Got a new officer who isn't in the list above?
 <a href="#" id="id_new_officer_btn">Add them</a></li>
<li>If you have a list on a computer, you can <a href="mailto:webmaster@cciw.co.uk">e-mail
  the webmaster</a> to have them imported more quickly.</li>
</ul>

</div>

<br style="clear: left;">
<script type="text/javascript">
(function($){
    // Define multiSelectFilter jQuery plugin
    $.fn.multiSelectFilter = function(select){
        var filterbox = this;
        // Make clone that stores options
        var select = $(select);
        var clone;

        var init = function() {
            if (clone != undefined) {
                clone.remove();
            }
            clone = select.clone();
            clone.removeAttr('id').removeAttr('name').hide();
            clone.appendTo(select.parent());
        }

        var filter = function(){
            select.children().remove();
            var term = $.trim(filterbox.val().toLowerCase());
            var tmp = [];
            clone.children().each(function(i, elem){
                            if (!term || elem.text.toLowerCase().indexOf(term) != -1) { 
                                tmp.push($('<div>').append($(elem).eq(0).clone()).html());
                            }
                         });
            select.append(tmp.join(''));
        }

        init();
        this.keyup(filter);

        // If the contents are changed, the clone needs to be refreshed,
        // so the 'refresh' event should be triggered on the filterbox.
        this.bind('refresh', function() {
            init();
            filter();
        });
        return this;

    };

    // Code specific to page
    var refreshLists = function() {
        var selectedIdx = document.getElementById("id_available_officers").selectedIndex;
        // Refresh different areas of the page:
        $.ajax({
            type: "GET",
            url: "?mode=chosen",
            success: function(text) {
                $("#id_officer_list_table").html(text);
                addOfficerListHandlers();
            }
        });
        $.ajax({
            type: "GET",
            url: "?mode=available",
            success: function(text) {
                $("#id_available_officers").html(text);
                // restore filter
                $("#id_available_officers_filter").trigger('refresh');
                // restore selected item
                var s = document.getElementById("id_available_officers");
                s.selectedIndex = Math.min(selectedIdx, s.options.length - 1);
            }
        });
        $.ajax({
            type: "GET",
            url: "?mode=noapplicationform",
            success: function(text) {
                $("#id_noapplicationform").html(text);
            }
        });
    };
    var addOfficerListHandlers = function() {
        // event handlers for all 'edit' buttons
        $(".editbtn").click(function(ev) {
            var officerId = parseFloat(ev.target.id.substring(8), 10);
            // Make input boxes
            // TODO
            // Add save/cancel buttons
            // TODO
            // Hide 'edit' button
            // TODO
            // Dim & disable other controls.
        });

        // event handlers for 'remove' buttons
        $(".removebtn").click(function(ev) {
            var officerId = parseFloat(ev.target.id.substring(10), 10);
            // Remove from list
            $.ajax({
                type: "POST",
                url:  "{% url cciw.officers.views.remove_officer camp.year camp.number %}",
                data: "officer_id=" + officerId.toString(),
                success: refreshLists
            });
            ev.preventDefault();
        });
    }
    var officerAddHandler = function(ev) {
        if (ev.type == "keyup") {
            var code = (ev.keyCode ? ev.keyCode : ev.which);
            if (code != 13) { // Enter
                return;
            }
        }
        $.ajax({
            type: "POST",
            url: "{% url cciw.officers.views.add_officer camp.year camp.number %}",
            data: "officer_id=" + ev.target.value,
            success: refreshLists
        });
    };

    var newOfficerHandler = function(ev) {
        var popup = $('#id_add_officer_popup');
        popup.find(".iframe_container").html('<iframe src="{% url cciw.officers.views.create_officer %}?is_popup=1" width="780" frameborder=0 height="400">');
        popup.css({
            "position": "fixed",
            "top": ($(window).height()/2 - popup.height()/2).toString() + "px",
            "left": ($(window).width()/2 - popup.width()/2).toString() + "px"
        });
        popup.fadeIn("fast");
        $('#id_popup_background').fadeIn('fast');
        ev.preventDefault();
    }

    var newOfficerClose = function(ev) {
        refreshLists();
        $('#id_add_officer_popup').fadeOut('fast');
        $('#id_popup_background').fadeOut('fast');
        ev.preventDefault();
    }

    $(document).ready(function(){
        $("#id_available_officers_filter").multiSelectFilter("#id_available_officers");
        addOfficerListHandlers();
        $("#id_available_officers")
           .dblclick(officerAddHandler)
           .keyup(officerAddHandler);
        $('#id_new_officer_btn').click(newOfficerHandler);
        $('#id_popup_close_btn').click(newOfficerClose)
    });
})(jQuery);
</script>

<h3>List address:</h3>
<p>The above list of officers can be emailed at:
<strong><a href="mailto:{{ address_all }}">{{ address_all }}</a></strong></p>

{% include "cciw/officers/email_list_note.html" %}

<div id="id_noapplicationform">
{% include "cciw/officers/officer_list_noapplicationform.html" %}
</div>

</div> {# id=content-main #}

<div id="id_add_officer_popup" class="inlinepopup">
<div class="closebar">
<a href="#" id="id_popup_close_btn">Close</a>
</div>
<div class="iframe_container">
</div>
</div>

<div class="inlinepopup_background" id="id_popup_background"></div>

{% endblock %}

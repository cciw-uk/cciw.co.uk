{% extends "cciw/officers/base.html" %}
{% load url from future %}
{% load adminmedia %}
{% load json_filters %}
{% block title %}Officer stats | CCIW Officers{% endblock %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% admin_media_prefix %}css/forms.css" />
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.flot.min.js"></script>

{% endblock %}
{% block bodyclass%}change-form{% endblock %}

{% block content %}
<div id="content-main">
<h1>Stats {{ year }}</h1>
<p>Charts span the year leading up to the start date of the camp.</p>
<p>Exact numbers can be seen by hovering your mouse over the charts.</p>

{% for stat in stats %}
<div style="float:left; margin-right: 20px;">
<h2>{{ stat.camp.number }} - {{ stat.camp.leaders_formatted }}</h2>

<div id="camp-graph-{{ stat.camp.number }}" style="width:600px;height:200px;">
</div>
<script type="text/javascript">
$(function() {
    var placeholder_id = "#camp-graph-{{ stat.camp.number }}";
    var app_dates_data = {{ stat.application_dates_data|jsonify }};
    var ref_dates_data = {{ stat.reference_dates_data|jsonify }};
    var all_crb_dates_data = {{ stat.all_crb_dates_data|jsonify }};
    var valid_crb_dates_data = {{ stat.valid_crb_dates_data|jsonify }};
    var officer_list_data = {{ stat.officer_list_data|jsonify }};
    $.plot(placeholder_id,
           [
            {label: "Officer list",
             data: officer_list_data},
            {label: "Any CRBs",
             data: all_crb_dates_data},
            {label: "Up-to-date CRBs",
             data: valid_crb_dates_data},
            {label: "Application forms",
             data: app_dates_data},
            {label: "References \u00F7 2",
             data: ref_dates_data}
           ],
           { xaxis: { mode: "time",
                      ticks: 12 },
             yaxis: { min: 0 },
             legend: { position: "nw" },
             grid: { hoverable: true }
           });

    function showTooltip(x, y, contents) {
        $('<div id="tooltip">' + contents + '</div>').css( {
            position: 'absolute',
            display: 'none',
            top: y + 5,
            left: x + 18,
            border: '1px solid #ddd',
            padding: '2px',
            'background-color': '#eee',
            opacity: 0.90
        }).appendTo("body").fadeIn(200);
    }

    var previousPoint = null;
    $(placeholder_id).bind("plothover", function (event, pos, item) {
        if (item) {
            if (previousPoint == null ||
                (previousPoint.dataIndex != item.dataIndex ||
                 previousPoint.series != item.series)) {
                previousPoint = item;

                $("#tooltip").remove();
                var d = new Date(item.datapoint[0]);
                var num = item.datapoint[1];
                var label = item.series.label;
                var stat = num.toFixed(0);
                if (item.series.label == "References \u00F7 2") {
                    label = "References";
                    stat = (num * 2).toFixed(0);
                }
                showTooltip(item.pageX, item.pageY,
                            label + ": <b>" + stat + "</b>" +
                            "<br/><i>" + d.toLocaleDateString() + "</i>");
            }
        }
        else {
            $("#tooltip").remove();
            previousPoint = null;
        }
    });

});
</script>
</div>
{% endfor %}


<div style="float: clear;">
<canvas height="50">
  Your browser is obsolete, and won't display the graphs above. Please upgrade
  to <a href="http://abetterbrowser.org/">a better browser</a>.
</canvas>
</div>

<p>Notes:</p>

<ul>
  <li>Ideally all lines should reach the 'Officer list' line by the start
    of camp.</li>
  <li>The figure for references received has been divided by 2 to make the plot
    fit the same target, since each officer needs 2 references. Correct figures
    are shown when hovering.</li>
  <li>Changes to the officer list are not tracked over time â€” only the current
    total is used.</li>
</ul>

</div>
{% endblock %}

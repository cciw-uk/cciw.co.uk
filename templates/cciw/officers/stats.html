{% extends "cciw/officers/base.html" %}
{% load url from future %}
{% load adminmedia %}
{% load json_filters %}
{% block title %}Officer stats | CCIW Officers{% endblock %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% admin_media_prefix %}css/forms.css" />
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.flot.min.js"></script>

{% endblock %}
{% block bodyclass%}change-form{% endblock %}

{% block content %}
<div id="content-main">
<h1>Stats {{ year }}</h1>
<table>
  <tr>
    <th>Camp</th>
    <th>Officer list</th>
    <th>Application forms</th>
    <th>Received references</th>
    <th colspan="2" style="text-align:center;">Based on number of application forms:</th>
    <th>Rank</th>
  </tr>
  <tr>
    <th colspan="4"></th>
    <th>Missing references</th>
    <th>Officers with no references</th>
    <th></th>
  </tr>

  {% for stat in stats %}
  <tr>
    <td>{{ stat.camp.number }} - {{ stat.camp.leaders_formatted }}</td>
    <td>{{ stat.invited_officers_count }}</td>
    <td>{{ stat.application_forms_count }}</td>
    <td>{{ stat.received_references_count }}</td>
    <td>{{ stat.missing_references_count }} ({{ stat.missing_references_percent|floatformat }}%) </td>
    <td>{{ stat.officers_no_reference }}</td>
    <td>{{ stat.rank }}
      {% if all_past %}
         {% if stat.rank == 1 %}<i>Winner!</i>{% endif %}
         {% if stat.rank == stat.lowest_rank %}<i>Loser!</i>{% endif %}
      {% else %}
         {% if stat.rank == 1 %}<i>Winning</i>{% endif %}
         {% if stat.rank == stat.lowest_rank %}<i>Losing</i>{% endif %}
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

{% if year == thisyear %}
<p>Camps may not be finished yet - there is still time to </p>
{% endif %}

{# Graphs #}

<h1 style="margin-top: 1em;">Timelines</h1>
<p>Charts end at the start date of the camp, and start a year before.</p>

{% for stat in stats %}
<div style="float:left; margin-right: 20px;">
<h2>{{ stat.camp.number }} - {{ stat.camp.leaders_formatted }}</h2>

<div id="camp-graph-{{ stat.camp.number }}" style="width:600px;height:150px;">
</div>
<script type="text/javascript">
$(function() {
    var placeholder_id = "#camp-graph-{{ stat.camp.number }}";
    var app_dates_data = {{ stat.application_dates_data|jsonify }};
    var ref_dates_data = {{ stat.reference_dates_data|jsonify }};
    var all_crb_dates_data = {{ stat.all_crb_dates_data|jsonify }};
    var valid_crb_dates_data = {{ stat.valid_crb_dates_data|jsonify }};
    var officer_list_data = {{ stat.officer_list_data|jsonify }};
    $.plot(placeholder_id,
           [
            {label: "Final officer list",
             data: officer_list_data},
            {label: "Any CRBs",
             data: all_crb_dates_data},
            {label: "Up-to-date CRBs",
             data: valid_crb_dates_data},
            {label: "Application forms",
             data: app_dates_data},
            {label: "References received / 2",
             data: ref_dates_data}
           ],
           { xaxis: { mode: "time",
                      ticks: 12 },
             yaxis: { min: 0 },
             legend: { position: "nw" },
             grid: { hoverable: true }
           });

    function showTooltip(x, y, contents) {
        $('<div id="tooltip">' + contents + '</div>').css( {
            position: 'absolute',
            display: 'none',
            top: y + 5,
            left: x + 5,
            border: '1px solid #ddd',
            padding: '2px',
            'background-color': '#eee',
            opacity: 0.90
        }).appendTo("body").fadeIn(200);
    }

    var previousPoint = null;
    $(placeholder_id).bind("plothover", function (event, pos, item) {
        if (item) {
            if (previousPoint == null ||
                (previousPoint.dataIndex != item.dataIndex ||
                 previousPoint.series != item.series)) {
                previousPoint = item;

                $("#tooltip").remove();
                var num = item.datapoint[1].toFixed(0),
                d = new Date(item.datapoint[0]);

                showTooltip(item.pageX, item.pageY,
                            item.series.label + ", on " + d.toLocaleDateString() + ": <b>" + num + "</b>");
            }
        }
        else {
            $("#tooltip").remove();
            previousPoint = null;
        }
    });

});
</script>
</div>
{% endfor %}


<div style="float: clear;">
<canvas height="50">
  Your browser is obsolete, and won't display the graphs above. Please upgrade
  to <a href="http://abetterbrowser.org/">a better browser</a>.
</canvas>
</div>


</div>
{% endblock %}

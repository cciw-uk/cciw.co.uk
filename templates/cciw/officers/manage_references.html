{% extends "cciw/officers/base.html" %}

{% load reference_utils %}
{% load static %}


{% block content %}
  <script type="text/javascript">
    document.body.addEventListener("htmx:afterSettle", function(detail) {
      // Move newly added 'id-manage-reference-' divs into their correct place,
      // which may have changed due to status change.

      const moveIntoPlace = (refreshedNode) => {
        const sortKey = (node) => JSON.parse(node.getAttribute("data-sort-key"));
        const mySortKey = sortKey(refreshedNode);
        if ((refreshedNode.previousElementSibling && sortKey(refreshedNode.previousElementSibling) > mySortKey) ||
          (refreshedNode.nextElementSibling && sortKey(refreshedNode.nextElementSibling) < mySortKey))
        {
          // This node is in the wrong place.

          var inserted = false;
          var previousNode = null;
          // Move it to correct place
          const parentNode = refreshedNode.parentElement;
          for (const node of parentNode.childNodes) {
            if (!node.tagName) {
              continue;
            }
            if (node != refreshedNode && (previousNode === null || sortKey(previousNode) < mySortKey) && (sortKey(node) >= mySortKey)) {
              // Found right place
              parentNode.insertBefore(refreshedNode, node);
              inserted = true;
            }
            previousNode = node;
          }
          if (!inserted) {
            // Must belong at end
            parentNode.insertBefore(refreshedNode, null);
          }
        }
      };

      var loadedNode = detail.target;
      if (loadedNode && loadedNode.id && loadedNode.id.startsWith("id-manage-reference")) {
        moveIntoPlace(loadedNode);
      }
    });
  </script>

  <div id="content-main">
    {% if officer %}
      <h3>For officer {{ officer.full_name }} <a href=".">(view all)</a></h3>

    {% endif %}

    {% if ref_email_search %}
      <h3>Filtering for referee email address = “{{ ref_email_search }}”</h3>
      <p><a href=".">(clear filter)</a></p> {# should use spurl to manipulate URLs but it doesn't support Python 3 yet #}
    {% endif %}

    <p>This page allows you to request references for officers who have submitted
      application forms. References that have not been requested are at the top,
      those that have been requested are in the middle, and those that have been
      received are at the bottom.  Within each section they are sorted
      alphabetically by officer name.
    </p>

    <p>For each reference that needs to be requested, choose from the options.
      The most likely option is listed first.</p>

    <p>If the referee does not respond quickly, you can request the reference again,
      or ask the officer concerned to contact their referee and ask for the
      reference.</p>

    {% if message %}
      <p><strong>{{ message }}</strong></p>
    {% endif %}

    <div class="manage-reference-list">
      {% for referee in all_referees %}
        {% include "cciw/officers/manage_reference.html" %}
      {% empty %}
        <div class="manage-reference manage-reference--notrequested">
          <p>No references/application forms found</p>
        </div>
      {% endfor %}
    </div>

  </div>
{% endblock %}

{% extends "cciw/officers/base.html" %}
{% load reference_utils %}
{% block title %}Manage references :: CCIW{% endblock %}
{% block extrastyle %}{{ block.super }}
<script type="text/javascript">
<!--

function toggleAddress(ev) {
    var addrblock = ev.src().nextSibling;
    if (hasElementClass(addrblock, "hidden")) {
	removeElementClass(addrblock, "hidden");
    } else {
	addElementClass(addrblock, "hidden");
    }
}

function toggleRefControls(ev) {
    var refcontrols = ev.src().nextSibling;
    if (hasElementClass(refcontrols, "hidden")) {
	removeElementClass(refcontrols, "hidden");
    } else {
	addElementClass(refcontrols, "hidden");
    }
}


function addToggleHandlers(ev) {
    var elems = getElementsByTagAndClassName("div", "firstline");
    for (var i = 0; i < elems.length; i++) {
	connect(elems[i], 'onclick', toggleAddress);
    }
    elems = getElementsByTagAndClassName("div", "refdetails");
    for (var i = 0; i < elems.length; i++) {
	connect(elems[i], 'onclick', toggleRefControls);
    }
}

connect(window, 'onload', 
	function(ev) {
	    addToggleHandlers();
	}
)

//-->
</script>
{% endblock %}

{% block content %}<div id="content-main">

<h1>Manage references</h1>
<h2>For camp {{ camp }}</h2>

<p>This page allows you to manage references for officers who have
  submitted application forms.</p>

{% if message %}
  <p><strong>{{ message }}</strong></p>
{% endif %}

<h2>References</h2>
{% if application_forms %}
  <form action="" method="POST">
  <table cellpadding="0" cellspacing="0">
    <tr>
      <th>Officer</th>
      <th>Referee 1</th>
      <th>Referee 2</th>
      <th>Last year</th>
    </tr>

    {% for app, prevapp, requested, received in application_forms %}
    {% with app.officer as officer %}
    {% with app.references as references %}
    <tr class="refrow">
      <td>{{ officer.first_name }} {{ officer.last_name }}
	{% if received %}
		<strong class="good">Complete</stong>
	{% else %}
		{% if requested %}
			<strong class="ok">Requested</stong>
		{% endif %}
	{% endif %}
	<br/>
	<a rel="external" href="{% url django.contrib.admin.views.main.change_stage "officers","application",app.id %}">Edit form</a>
        <input name="appids" value="{{ app.id }}" type="hidden" />
      </td>
      {% for referee in app.referees %}
      {# hack - really we want  zip(app.referees, app.references) #}
      {% for reference in app.references %}{% ifequal forloop.counter forloop.parentloop.counter %}
      <td>{{ referee.name }} {% ifnotequal referee.usedcount 1 %}<span class="refcount ref{{ referee.id }}">{{ referee.usedcount }}</span>{% endifnotequal %}<br />
	{{ referee.address|firstline }}
	{% if referee.tel %}<div>{{ referee.tel }}</div>{% endif %}
	{% if referee.mobile %}<div>{{ referee.mobile }}</div>{% endif %}
	{% if referee.email %}<div>{{ referee.email }}</div>{% endif %}
	<div class="refdetails">Reference:
	</div><div class="refcontrols hidden">
	  <label for="req_{{ forloop.counter }}_{{ app.id }}">Requested </label><input id="req_{{ forloop.counter }}_{{ app.id }}" name="req_{{ forloop.counter }}_{{ app.id }}" value="1" type="checkbox" {% if reference.requested %}checked="checked"{% endif %} /><br />
	  <label for="rec_{{ forloop.counter }}_{{ app.id }}">Received <label><input id="rec_{{ forloop.counter}}_{{ app.id }}" name="rec_{{ forloop.counter}}_{{ app.id }}" value="1" type="checkbox"  {% if reference.received %}checked="checked"{% endif %} /><br />
	  <label for="comments_{{ forloop.counter }}_{{ app.id }}">Comments</label><br />
	  <textarea name="comments_{{ forloop.counter }}_{{ app.id }}" id="comments_{{ forloop.counter }}_{{ app.id }}" cols="40" rows="4">{{ reference.comments }}</textarea>
	</div>
      </td>
      {% endifequal %}{% endfor %}
      {% endfor %}
      
      <td class="nopadding">
	<table cellpadding="0" cellspacing="0">
	  <tr>
	    {% for referee in prevapp.referees %}
	    <td width="50%">{{ referee.name }}<br />
	      {{ referee.address|firstline }}
	      {% if referee.tel %}<div>{{ referee.tel }}</div>{% endif %}
	      {% if referee.mobile %}<div>{{ referee.mobile }}</div>{% endif %}
	      {% if referee.email %}<div>{{ referee.email }}</div>{% endif %}
	    </td>
	    {% endfor %}
	  </tr>
	  <tr>
	    <td colspan="2">
	      {% if prevapp %}[{{ prevapp.camp }}]{% endif %}
	    </td>
	  </tr>
        </table>
      </td>
    </tr>
    {% endwith %}
    {% endwith %}
    {% endfor %}
  </table>

  <input type="submit" name="save" value="Save" />
  </form>

{% else %}
  <p>No application forms completed yet.</p>

{% endif %}

</div>{% endblock %}

{% extends "cciw/officers/base.html" %}

{% load reference_utils %}
{% load static %}


{% block bodyclass %}manage-references-page{% endblock %}

{% block content %}
  <script type="text/javascript">
    //<![CDATA[

    document.body.addEventListener("refreshReference", function(evt) {
      const refereeId = evt.detail.value;
      const refereeSelector = "#id-manage-reference-" + refereeId.toString()
      const moveIntoPlace = () => {
        const refreshedNode = document.querySelector(refereeSelector);
        const sortKey = (node) => JSON.parse(node.getAttribute("data-sort-key"));
        const mySortKey = sortKey(refreshedNode);
        if ((refreshedNode.previousElementSibling && sortKey(refreshedNode.previousElementSibling) > mySortKey) ||
          (refreshedNode.nextElementSibling && sortKey(refreshedNode.nextElementSibling) < mySortKey))
        {
          // this node is in the wrong place.

          var inserted = false;
          var previousNode = null;
          // Move it to correct place
          const parentNode = refreshedNode.parentElement;
          for (const node of parentNode.childNodes) {
            if (!node.tagName) {
              continue;
            }
            if ((previousNode === null || sortKey(previousNode) < mySortKey) && (sortKey(node) >= mySortKey)) {
              // Found right place
              parentNode.insertBefore(refreshedNode, node);
              inserted = true;
            }
            previousNode = node;
          }
          if (!inserted) {
            // Must belong at end
            parentNode.insertBefore(refreshedNode, null);
          }
        }
      };

      htmx.ajax("GET", "?referee_id=" + refereeId.toString(), {
        target: refereeSelector,
        swap: "outerHTML",
      }).then(moveIntoPlace);
    });

    //]]>
  </script>

  <div id="content-main">
    {% if officer %}
      <h3>For officer {{ officer.full_name }} <a href=".">(view all)</a></h3>

    {% endif %}

    {% if ref_email_search %}
      <h3>Filtering for referee email address = “{{ ref_email_search }}”</h3>
      <p><a href=".">(clear filter)</a></p> {# should use spurl to manipulate URLs but it doesn't support Python 3 yet #}
    {% endif %}

    <p>This page allows you to request references for officers who have submitted
      application forms. References that have not been requested are at the top,
      those that have been requested are in the middle, and those that have been
      received are at the bottom.  Within each section they are sorted
      alphabetically by officer name.
    </p>

    <p>For each reference that needs to be requested, choose from the options.  An
      option only appears if it is possible, and the most likely option is listed
      first.</p>

    <p>All of the <button>Request...</button> action buttons open new windows in which you may need
      to edit a default email and confirm. You will also be given the option to
      fill in reference form manually if the referee can't use the online system.</p>

    <p>If the referee does not respond quickly, you can request the reference again,
      or ask the officer concerned to contact their referee and ask for the
      reference.</p>

    {% if message %}
      <p><strong>{{ message }}</strong></p>
    {% endif %}

    <div class="manage-reference-list">
      {% for referee in all_referees %}
        {% include "cciw/officers/manage_reference.html" %}
      {% empty %}
        <div class="manage-reference manage-reference--notrequested">
          <p>No references/application forms found</p>
        </div>
      {% endfor %}
    </div>

  </div>
{% endblock %}
